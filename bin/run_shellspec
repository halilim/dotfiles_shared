#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

shopt -s globstar

both_specs=(spec/includes/lib/*_spec.sh)

bash_specs=(
  spec/**/*_spec.bash
  spec/link/home/bin_spec.sh # This should work in both, but not much point in testing for both
  spec/link/home/bin/dotfiles_spec.sh
)
bash_specs+=("${both_specs[@]}")

zsh_specs=(spec/**/*_spec.zsh)
zsh_specs+=("${both_specs[@]}")

if [[ ${DRY_RUN:-} ]]; then
  if [[ ! ${ZSH_ONLY:-} ]]; then
    echo 'Bash specs:'
    printf '%s\n' "${bash_specs[@]}" "$@" | sort
  fi

  if [[ ! ${BASH_ONLY:-} ]]; then
    printf '\nZsh specs:\n'
    printf '%s\n' "${zsh_specs[@]}" "$@" | sort
  fi
else
  # TODO: Aborted with status code [executor: 126] [reporter: 1] [error handler: 0]
  if [ -v TERMUX_VERSION ]; then
    # shellcheck disable=SC1091
    . "$HOME"/.dotfiles_bootstrap.sh
    # shellcheck disable=SC1091
    . "$DOTFILES_INCLUDES"/lib/functions.sh

    color 'yellow' 'Skipping on Termux...'
    exit 0
  fi

  pattern='*_spec.*sh'

  if [[ ! ${ZSH_ONLY:-} ]]; then
    shellspec --shell bash --pattern "$pattern" "${bash_specs[@]}" "$@"
  fi

  if [[ ! ${BASH_ONLY:-} ]]; then
    shellspec --shell zsh --pattern "$pattern" "${zsh_specs[@]}" "$@"
  fi
fi
